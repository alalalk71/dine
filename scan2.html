<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Scan 2</title>
<style>
  body { font-family: Tahoma, sans-serif; padding: 20px; }
  h3 { margin-top: 20px; margin-bottom: 5px; }
  .checkbox-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
  .checkbox-row div { display: flex; align-items: center; gap: 3px; }
  table { border-collapse: collapse; margin-top: 20px; width: 100%; table-layout: fixed; }
  th, td { border: 1px solid #333; padding: 5px; text-align: center; vertical-align: top; font-size: 12px; }
  th { background-color: #000; color: #fff; position: sticky; z-index: 3; }
  tr:hover td { background-color: #000; color: #fff; }
  th.tf-top { top: 0; z-index: 5; }
  th.tf-bottom { top: 30px; z-index: 4; }
  td + td { border-left: 3px solid #000; }
</style>
</head>
<body>

<h2>فیلتر بر اساس وضعیت فیلدها</h2>
<div id="fields" class="checkbox-row"></div>

<h3>تایم فریم‌ها</h3>
<div id="timeframes" class="checkbox-row"></div>

<button onclick="generateTable()">نمایش جدول</button>

<div id="result"></div>

<script>
const dataUrl = 'https://raw.githubusercontent.com/alalalk71/dine/refs/heads/main/data.json';

const timeframesList = ["1m","3m","5m","15m","30m","1h","2h","4h","6h","12h","1d","3d","1w"];
const fieldsList = ["cm55","m55","m200","cm200","dm","dr","mr","sros","srob","srd","cci14_ob","cci14_os","cci14_s","cci14_n","cci14_m","cci50_ob","cci50_os","cci50_s","cci50_n","cci50_m","obv_dn","obv_ds","obv_m"];

async function loadData() {
  const res = await fetch(dataUrl);
  return await res.json();
}

function createFieldFilter(field) {
  const div = document.createElement('div');
  const label = document.createElement('span');
  label.textContent = field;

  const cbYes = document.createElement('input');
  cbYes.type = 'checkbox';
  cbYes.id = field + '_yes';

  const lblYes = document.createElement('label');
  lblYes.htmlFor = field + '_yes';
  lblYes.textContent = '✅';

  const cbNo = document.createElement('input');
  cbNo.type = 'checkbox';
  cbNo.id = field + '_no';

  const lblNo = document.createElement('label');
  lblNo.htmlFor = field + '_no';
  lblNo.textContent = '❌';

  div.appendChild(label);
  div.appendChild(cbYes);
  div.appendChild(lblYes);
  div.appendChild(cbNo);
  div.appendChild(lblNo);
  return div;
}

async function init() {
  const fieldContainer = document.getElementById('fields');
  fieldsList.forEach(f => {
    const div = createFieldFilter(f);
    fieldContainer.appendChild(div);
  });

  const tfContainer = document.getElementById('timeframes');
  timeframesList.forEach(tf => {
    const div = document.createElement('div');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = 'tf_' + tf;
    const lbl = document.createElement('label');
    lbl.htmlFor = 'tf_' + tf;
    lbl.textContent = tf;
    div.appendChild(cb);
    div.appendChild(lbl);
    tfContainer.appendChild(div);
  });
}

async function generateTable() {
  const data = await loadData();
  const resultContainer = document.getElementById('result');

  const selectedTFs = Array.from(document.querySelectorAll('#timeframes input:checked')).map(cb => cb.id.replace('tf_',''));

  // استخراج فیلترها: فقط فیلدهایی که یکی از چک‌باکس‌های ✅ یا ❌ خورده‌اند
  const selectedFields = fieldsList.filter(f => {
    return document.getElementById(f+'_yes').checked || document.getElementById(f+'_no').checked;
  });

  if(selectedTFs.length === 0 || selectedFields.length === 0){
    resultContainer.innerHTML = "<p>لطفاً حداقل یک تایم فریم و یک فیلد (با ✅ یا ❌) انتخاب کنید.</p>";
    return;
  }

  let coins = Object.keys(data["Top Coins"]);

  // فیلتر بر اساس انتخاب کاربر
  coins = coins.filter(coin => {
    return selectedTFs.some(tf => {
      if(!data["Top Coins"][coin][tf]) return false;
      return selectedFields.every(f => {
        const value = data["Top Coins"][coin][tf][f+"_fmt"];
        if(document.getElementById(f+'_yes').checked && value !== '✅') return false;
        if(document.getElementById(f+'_no').checked && value !== '❌') return false;
        return true;
      });
    });
  });

  let tableHTML = '<table>';
  // ردیف اول: تایم‌فریم‌ها
  tableHTML += '<tr><th rowspan="2">کوین</th>';
  selectedTFs.forEach(tf => {
    tableHTML += `<th class="tf-top" colspan="${selectedFields.length}">${tf}</th>`;
  });
  tableHTML += '</tr>';

  // ردیف دوم: فقط فیلدهای انتخاب‌شده
  tableHTML += '<tr>';
  selectedTFs.forEach(tf => {
    selectedFields.forEach(f => {
      tableHTML += `<th class="tf-bottom">${f}</th>`;
    });
  });
  tableHTML += '</tr>';

  coins.forEach(coin => {
    tableHTML += `<tr><td>${coin}</td>`;
    selectedTFs.forEach(tf => {
      selectedFields.forEach(f => {
        let value = data["Top Coins"][coin][tf] ? data["Top Coins"][coin][tf][f+"_fmt"] || '' : '';
        tableHTML += `<td>${value}</td>`;
      });
    });
    tableHTML += '</tr>';
  });

  tableHTML += '</table>';
  resultContainer.innerHTML = tableHTML;
}

init();
</script>
</body>
</html>
