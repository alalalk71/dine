<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Scan 2 - دسته‌بندی و All Categories</title>
<style>
  body { font-family: Tahoma, sans-serif; padding: 20px; }
  h3 { margin-top: 20px; margin-bottom: 5px; }
  .checkbox-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
  .checkbox-row div { display: flex; align-items: center; gap: 6px; }

  .table-container { overflow: auto; max-height: 600px; width: 100%; }
  table { border-collapse: collapse; width: 100%; table-layout: fixed; }
  th, td { border: 1px solid #333; padding: 6px; text-align: center; vertical-align: middle; font-size: 13px; }

  /* Header sticky */
  th.tf-top { position: sticky; top: 0; background-color: #000; color: #fff; z-index: 6; height: 34px; }
  th.tf-bottom { position: sticky; top: 34px; background-color: #000; color: #fff; z-index: 5; height: 34px; }

  /* First column sticky (coin names) */
  th.first-col, td.coin-cell { position: sticky; left: 0; background-color: #000; color: #fff; z-index: 7; border-right: 3px solid #000; }

  /* Border between timeframes */
  th.tf-header { border-right: 3px solid #000; }

  /* Hover coin row style (only first column changes) */
  td.coin-cell:hover { background-color: #000; color: #fff; }

  /* Slight zebra for readability */
  tbody tr:nth-child(odd) td { background: #fafafa; }
  tbody tr:nth-child(odd) td.coin-cell { background: #000; color: #fff; }
</style>
</head>
<body>

<h2>Scan 2 — فیلتر بر اساس وضعیت فیلدها و دسته‌بندی</h2>

<h3>دسته‌بندی‌ها</h3>
<div id="categories" class="checkbox-row"></div>

<h3>تایم فریم‌ها</h3>
<div id="timeframes" class="checkbox-row"></div>

<h3>فیلدها (برای هر فیلد ✅ یا ❌ را انتخاب کنید)</h3>
<div id="fields" class="checkbox-row"></div>

<button onclick="generateTable()">نمایش جدول</button>

<div class="table-container" id="result"></div>

<script>
const dataUrl = 'https://raw.githubusercontent.com/alalalk71/dine/refs/heads/main/data.json';
const timeframesList = ["1m","3m","5m","15m","30m","1h","2h","4h","6h","12h","1d","3d","1w"];
const fieldsList = ["cm55","m55","m200","cm200","dm","dr","mr","sros","srob","srd","cci14_ob","cci14_os","cci14_s","cci14_n","cci14_m","cci50_ob","cci50_os","cci50_s","cci50_n","cci50_m","obv_dn","obv_ds","obv_m"];

async function loadData(){
  const res = await fetch(dataUrl);
  return await res.json();
}

function createCategoryCheckbox(cat){
  const div = document.createElement('div');
  const cb = document.createElement('input');
  cb.type = 'checkbox';
  cb.className = 'cat-checkbox';
  cb.id = 'cat_' + cat;
  const lbl = document.createElement('label');
  lbl.htmlFor = cb.id;
  lbl.textContent = cat;
  div.appendChild(cb);
  div.appendChild(lbl);
  return div;
}

function createFieldFilter(field){
  const div = document.createElement('div');
  const name = document.createElement('span');
  name.textContent = field;
  name.style.marginRight = '6px';

  const cbYes = document.createElement('input');
  cbYes.type = 'checkbox';
  cbYes.id = field + '_yes';

  const lblYes = document.createElement('label');
  lblYes.htmlFor = cbYes.id;
  lblYes.textContent = '✅';
  lblYes.style.marginRight = '6px';

  const cbNo = document.createElement('input');
  cbNo.type = 'checkbox';
  cbNo.id = field + '_no';

  const lblNo = document.createElement('label');
  lblNo.htmlFor = cbNo.id;
  lblNo.textContent = '❌';

  div.appendChild(name);
  div.appendChild(cbYes);
  div.appendChild(lblYes);
  div.appendChild(cbNo);
  div.appendChild(lblNo);
  return div;
}

async function init(){
  const data = await loadData();

  // categories
  const catContainer = document.getElementById('categories');
  // All categories checkbox
  const allDiv = document.createElement('div');
  const allCb = document.createElement('input');
  allCb.type = 'checkbox';
  allCb.id = 'all_categories';
  const allLbl = document.createElement('label');
  allLbl.htmlFor = 'all_categories';
  allLbl.textContent = 'All Categories';
  allDiv.appendChild(allCb);
  allDiv.appendChild(allLbl);
  catContainer.appendChild(allDiv);

  Object.keys(data).forEach(cat => {
    const node = createCategoryCheckbox(cat);
    catContainer.appendChild(node);
  });

  // when all_categories toggled, check/disable other checkboxes
  allCb.addEventListener('change', () => {
    const cats = document.querySelectorAll('.cat-checkbox');
    cats.forEach(cb => {
      cb.checked = allCb.checked;
      cb.disabled = allCb.checked;
    });
  });

  // timeframes
  const tfContainer = document.getElementById('timeframes');
  timeframesList.forEach(tf => {
    const div = document.createElement('div');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = 'tf_' + tf;
    const lbl = document.createElement('label');
    lbl.htmlFor = cb.id;
    lbl.textContent = tf;
    div.appendChild(cb);
    div.appendChild(lbl);
    tfContainer.appendChild(div);
  });

  // fields
  const fieldContainer = document.getElementById('fields');
  fieldsList.forEach(f => {
    fieldContainer.appendChild(createFieldFilter(f));
  });
}

function getSelectedCategories(data){
  const allCb = document.getElementById('all_categories');
  if(allCb && allCb.checked) return Object.keys(data);
  // otherwise selected cat checkboxes
  const selected = Array.from(document.querySelectorAll('.cat-checkbox:checked')).map(cb => cb.id.replace('cat_',''));
  return selected;
}

async function generateTable(){
  const data = await loadData();
  const resultContainer = document.getElementById('result');

  const selectedTFs = Array.from(document.querySelectorAll('#timeframes input:checked')).map(cb => cb.id.replace('tf_',''));
  const selectedFields = fieldsList.filter(f => document.getElementById(f + '_yes').checked || document.getElementById(f + '_no').checked);

  const selectedCats = getSelectedCategories(data);

  if(selectedTFs.length === 0 || selectedFields.length === 0 || selectedCats.length === 0){
    resultContainer.innerHTML = '<p>لطفاً حداقل یک تایم‌فریم، یک فیلد (با ✅ یا ❌) و یک دسته‌بندی انتخاب کنید.</p>';
    return;
  }

  // union of coins from selected categories
  const coinSet = new Set();
  selectedCats.forEach(cat => {
    if(data[cat]){
      Object.keys(data[cat]).forEach(c => coinSet.add(c));
    }
  });
  let coins = Array.from(coinSet).sort();

  // filter coins: coin passes if there exists a selectedTF and a category (from selectedCats)
  // such that all selectedFields match the chosen ✅/❌ for that (cat, coin, tf)
  coins = coins.filter(coin => {
    return selectedTFs.some(tf => {
      return selectedCats.some(cat => {
        if(!data[cat] || !data[cat][coin] || !data[cat][coin][tf]) return false;
        return selectedFields.every(f => {
          const val = data[cat][coin][tf][f + '_fmt'];
          if(document.getElementById(f + '_yes').checked && val !== '✅') return false;
          if(document.getElementById(f + '_no').checked && val !== '❌') return false;
          return true;
        });
      });
    });
  });

  // build table
  let tableHTML = '<div class="table-container"><table>';

  // header row 1 (timeframes)
  tableHTML += '<thead>';
  tableHTML += '<tr>';
  tableHTML += '<th class="first-col" rowspan="2">کوین</th>';
  selectedTFs.forEach(tf => {
    tableHTML += `<th class="tf-top tf-header" colspan="${selectedFields.length}">${tf}</th>`;
  });
  tableHTML += '</tr>';

  // header row 2 (fields)
  tableHTML += '<tr>';
  selectedTFs.forEach(tf => {
    selectedFields.forEach(f => {
      tableHTML += `<th class="tf-bottom">${f}</th>`;
    });
  });
  tableHTML += '</tr>';
  tableHTML += '</thead>';

  // body rows
  tableHTML += '<tbody>';
  coins.forEach(coin => {
    tableHTML += `<tr><td class="coin-cell">${coin}</td>`;
    selectedTFs.forEach(tf => {
      selectedFields.forEach(f => {
        // find first category that has the value
        let value = '';
        for(const cat of selectedCats){
          if(data[cat] && data[cat][coin] && data[cat][coin][tf] && data[cat][coin][tf][f + '_fmt'] !== undefined){
            value = data[cat][coin][tf][f + '_fmt'];
            break;
          }
        }
        tableHTML += `<td>${value}</td>`;
      });
    });
    tableHTML += '</tr>';
  });
  tableHTML += '</tbody>';

  tableHTML += '</table></div>';
  resultContainer.innerHTML = tableHTML;
}

init();
</script>

</body>
</html>
