<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Scan Matrix Final</title>
<style>
  body { font-family: Tahoma, sans-serif; padding: 20px; }
  h3 { margin-top: 20px; margin-bottom: 5px; }
  .checkbox-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; }
  .checkbox-row div { display: flex; align-items: center; gap: 3px; }
  table { border-collapse: collapse; margin-top: 20px; width: 100%; table-layout: fixed; }
  th, td { border: 1px solid #333; padding: 5px; text-align: center; vertical-align: middle; font-size: 14px; }
  th { background-color: #eee; }
  th.tf-header { background-color: #ddd; font-weight: bold; }
</style>
</head>
<body>

<h2>انتخاب دسته‌بندی، تایم فریم و فیلدها</h2>

<h3>دسته‌بندی‌ها</h3>
<div id="categories" class="checkbox-row"></div>

<h3>تایم فریم‌ها</h3>
<div id="timeframes" class="checkbox-row"></div>

<h3>فیلدها</h3>
<div id="fields" class="checkbox-row"></div>

<button onclick="generateTable()">نمایش جدول</button>

<div id="result"></div>

<script>
const dataUrl = 'https://raw.githubusercontent.com/alalalk71/dine/refs/heads/main/data.json';

const timeframesList = ["1m","3m","5m","15m","30m","1h","2h","4h","6h","12h","1d","3d","1w"];
const fieldsList = ["cm55","m55","m200","cm200","dm","dr","mr","sros","srob","srd",
"cci14_ob","cci14_os","cci14_s","cci14_n","cci14_m","cci50_ob","cci50_os","cci50_s",
"cci50_n","cci50_m","obv_dn","obv_ds","obv_m"];

async function loadData() {
    const res = await fetch(dataUrl);
    return await res.json();
}

function createCheckbox(id, label) {
    const div = document.createElement('div');
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.id = id;
    const lbl = document.createElement('label');
    lbl.htmlFor = id;
    lbl.textContent = label;
    div.appendChild(cb);
    div.appendChild(lbl);
    return div;
}

async function init() {
    const data = await loadData();

    const catContainer = document.getElementById('categories');
    Object.keys(data).forEach(cat => {
        catContainer.appendChild(createCheckbox('cat_' + cat, cat));
    });

    const tfContainer = document.getElementById('timeframes');
    timeframesList.forEach(tf => {
        tfContainer.appendChild(createCheckbox('tf_' + tf, tf));
    });

    const fieldContainer = document.getElementById('fields');
    fieldsList.forEach(f => {
        fieldContainer.appendChild(createCheckbox('field_' + f, f));
    });
}

async function generateTable() {
    const data = await loadData();
    const resultContainer = document.getElementById('result');

    const selectedCats = Array.from(document.querySelectorAll('#categories input:checked')).map(cb => cb.id.replace('cat_',''));
    const selectedTFs = Array.from(document.querySelectorAll('#timeframes input:checked')).map(cb => cb.id.replace('tf_',''));
    const selectedFields = Array.from(document.querySelectorAll('#fields input:checked')).map(cb => cb.id.replace('field_',''));

    if(selectedCats.length === 0 || selectedTFs.length === 0 || selectedFields.length === 0){
        resultContainer.innerHTML = "<p>لطفاً حداقل یک دسته‌بندی، یک تایم فریم و یک فیلد انتخاب کنید.</p>";
        return;
    }

    // استخراج کوین‌ها
    let allCoins = new Set();
    selectedCats.forEach(cat => {
        Object.keys(data[cat]).forEach(coin => allCoins.add(coin));
    });
    allCoins = Array.from(allCoins).sort();

    // ساخت جدول با دو ردیف header
    let tableHTML = '<table>';

    // ردیف اول: تایم فریم‌ها با colspan
    tableHTML += '<tr><th rowspan="2">کوین</th>';
    selectedTFs.forEach(tf => {
        tableHTML += `<th colspan="${selectedFields.length}">${tf}</th>`;
    });
    tableHTML += '</tr>';

    // ردیف دوم: فیلدها
    tableHTML += '<tr>';
    selectedTFs.forEach(tf => {
        selectedFields.forEach(f => {
            tableHTML += `<th>${f}</th>`;
        });
    });
    tableHTML += '</tr>';

    // ردیف‌ها: کوین‌ها
    allCoins.forEach(coin => {
        tableHTML += `<tr><td>${coin}</td>`;
        selectedTFs.forEach(tf => {
            selectedFields.forEach(f => {
                let value = '❌';
                for(const cat of selectedCats){
                    if(data[cat] && data[cat][coin] && data[cat][coin][tf] && data[cat][coin][tf][f + "_fmt"] !== undefined){
                        value = data[cat][coin][tf][f + "_fmt"];
                        break;
                    }
                }
                tableHTML += `<td>${value}</td>`;
            });
        });
        tableHTML += '</tr>';
    });

    tableHTML += '</table>';
    resultContainer.innerHTML = tableHTML;
}

init();
</script>

</body>
</html>
